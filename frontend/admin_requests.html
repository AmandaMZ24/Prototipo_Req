<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Solicitudes de Adopci√≥n - Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('background.png');
      margin: 20px;
    }
    select, button {
      margin: 10px;
      padding: 5px;
    }
    .request-card {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .request-card h3 {
      margin: 0 0 5px;
    }
  </style>
</head>
<body>

<h1>Solicitudes de Adopci√≥n</h1>

<div>
  <label>Filtrar por estado:</label>
  <select id="statusFilter">
    <option value="">Todos</option>
    <option value="En revisi√≥n">En revisi√≥n</option>
    <option value="Aprobada">Aprobadas</option>
    <option value="Rechazada">Rechazadas</option>
  </select>
  <button onclick="loadRequests()">Filtrar</button>
</div>

<div id="list">Cargando...</div>

<p><a href="pets.html">‚Üê Volver</a></p>

<script>
const API = "http://127.0.0.1:5000/requests/admin";
const token = localStorage.getItem("token");

// üß© Cargar solicitudes
async function loadRequests() {
  const status = document.getElementById("statusFilter").value;
  const url = status ? `${API}?status=${encodeURIComponent(status)}` : API;

  try {
    const res = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("No se pudieron obtener las solicitudes");
    const requests = await res.json();

    const listDiv = document.getElementById("list");
    if (requests.length === 0) {
      listDiv.innerHTML = "<p>No hay solicitudes.</p>";
      return;
    }

    listDiv.innerHTML = "";
    requests.forEach(r => {
      const div = document.createElement("div");
      div.className = "request-card";
      div.innerHTML = `
        <h3>${r.user_name} solicita a ${r.pet_name}</h3>
        <p><b>Estado:</b> ${r.status}</p>
        <p><b>Motivo:</b> ${r.reason || "(sin motivo)"}</p>
        <p><b>Fecha:</b> ${new Date(r.request_date).toLocaleDateString()}</p>
        <label>Cambiar estado:</label>
        <select id="status-${r.id}">
          <option value="En revisi√≥n" ${r.status==="En revisi√≥n"?"selected":""}>En revisi√≥n</option>
          <option value="Aprobada" ${r.status==="Aprobada"?"selected":""}>Aprobada</option>
          <option value="Rechazada" ${r.status==="Rechazada"?"selected":""}>Rechazada</option>
        </select>
        <button onclick="updateStatus(${r.id})">Guardar</button>
      `;
      listDiv.appendChild(div);
    });
  } catch (e) {
    alert(e.message);
  }
}

// üß© Actualizar estado
async function updateStatus(id) {
  const newStatus = document.getElementById(`status-${id}`).value;
  try {
    const res = await fetch(`http://127.0.0.1:5000/requests/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ status: newStatus })
    });
    const data = await res.json();
    alert(data.msg || "Estado actualizado");
    loadRequests(); // recargar
  } catch (e) {
    alert("Error al actualizar estado");
  }
}

document.addEventListener("DOMContentLoaded", loadRequests);
</script>

</body>
</html>
